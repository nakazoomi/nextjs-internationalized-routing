"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
var templateWithHoc_1 = __importDefault(require("./templateWithHoc"));
var templateWithLoader_1 = __importDefault(require("./templateWithLoader"));
var utils_1 = require("./utils");
var defaultAppPath = process.cwd() + '/node_modules/next/dist/pages/_app';
function loader(rawCode) {
    var _a = this.query, hasGetInitialPropsOnAppJs = _a.hasGetInitialPropsOnAppJs, extensionsRgx = _a.extensionsRgx, pagesPath = _a.pagesPath, hasLoadLocaleFrom = _a.hasLoadLocaleFrom;
    if (this.resourcePath.startsWith(defaultAppPath))
        return utils_1.getDefaultAppJs(hasLoadLocaleFrom);
    if (!this.resourcePath.startsWith(pagesPath))
        return rawCode;
    var page = this.resourcePath.replace(pagesPath, '/', '');
    var pageNoExt = page.replace(extensionsRgx, '');
    var code = rawCode.replace(utils_1.clearCommentsRgx, '');
    var typescript = page.endsWith('.ts') || page.endsWith('.tsx');
    if (!code.includes('export default'))
        return rawCode;
    if (hasGetInitialPropsOnAppJs) {
        return pageNoExt === '/_app'
            ? templateWithHoc_1.default(rawCode, { typescript: typescript, hasLoadLocaleFrom: hasLoadLocaleFrom })
            : rawCode;
    }
    if (pageNoExt === '/_app') {
        return templateWithHoc_1.default(rawCode, {
            skipInitialProps: true,
            typescript: typescript,
            hasLoadLocaleFrom: hasLoadLocaleFrom,
        });
    }
    if (utils_1.isPageToIgnore(page))
        return rawCode;
    var isWrapperWithExternalHOC = utils_1.hasHOC(code);
    var isDynamicPage = page.includes('[');
    var isGetInitialProps = !!code.match(/\WgetInitialProps\W/g);
    var isGetServerSideProps = utils_1.hasExportName(code, 'getServerSideProps');
    var isGetStaticPaths = utils_1.hasExportName(code, 'getStaticPaths');
    var isGetStaticProps = utils_1.hasExportName(code, 'getStaticProps');
    var hasLoader = isGetStaticProps || isGetServerSideProps || isGetInitialProps;
    if (isGetInitialProps || (!hasLoader && isWrapperWithExternalHOC)) {
        return templateWithHoc_1.default(rawCode, { typescript: typescript, hasLoadLocaleFrom: hasLoadLocaleFrom });
    }
    var loader = isGetServerSideProps || (!hasLoader && isDynamicPage && !isGetStaticPaths)
        ? 'getServerSideProps'
        : 'getStaticProps';
    return templateWithLoader_1.default(rawCode, {
        page: pageNoExt,
        typescript: typescript,
        loader: loader,
        hasLoader: hasLoader,
        hasLoadLocaleFrom: hasLoadLocaleFrom,
    });
}
exports.default = loader;
